<html>
<script src='https://d3js.org/d3.v5.min.js'></script>

<body onload='init()'>

<div id="dd-container">
	<label for="dd_date_range"><strong><h3>Please select a date range:</h3></strong></label>
	<select id="dd_date_range">
		<option value="5years">5 Years</option>
		<option value="1year">1 Year</option>
		<option value="3months">3 Months</option>
		<option value="1month">1 Month</option>
	</select>
</div>	

<div id="chart-container">
</div>


<script>
async function init() 
{
	//Load JPM CSV file
	//------------------
	const data = await d3.csv("https://nithy85.github.io/CS416datavisualization/JPM.csv");
	
	
	//Intial chart with entire dataset of 5 years
	//--------------------------------------------
	line_graph(data)

	
	// Filter data based on date range selection in dropdown
	//--------------------------------------------------------
	const currentdate = new Date();
	const currentyear = currentdate.getFullYear();
	const currentmonth = currentdate.getMonth();

	 d3.select("#dd_date_range")
         .on("change", function () 
		 {
            const selectedValue = this.value;
			if(selectedValue=="5years")
			{
				var filteredData = data; 
				d3.selectAll("svg").remove();
				line_graph(filteredData);
			}
			if(selectedValue=="1year")
			{
				var filteredData = data.filter(function(d) 
				{ 
					const data_year= (new Date(d.Date)).getFullYear()
        			if(data_year==currentyear)
					{ 
            			return d;
        			} 
    			}) 
				d3.selectAll("svg").remove();
				line_graph(filteredData)
			}
			if(selectedValue=="3months")
			{
				var filteredData = data.filter(function(d) 
				{ 
					const data_year= (new Date(d.Date)).getFullYear()
        			if(data_year==currentyear)
					{ 
						const data_month= (new Date(d.Date)).getMonth()
						if(data_month >= (currentmonth-2))
						{
            				return d;
						}
        			} 
    			}) 
				d3.selectAll("svg").remove();
				line_graph(filteredData)
			}
			if(selectedValue=="1month")
			{
				var filteredData = data.filter(function(d) 
				{ 
					const data_year= (new Date(d.Date)).getFullYear()
        			if(data_year==currentyear)
					{ 
						const data_month= (new Date(d.Date)).getMonth()
						if(currentmonth == data_month)
						{
            				return d;
						}
        			} 
    			}) 
				d3.selectAll("svg").remove();
				line_graph(filteredData)
			}
		})

	function line_graph(data)
	{
		//Type convertion of date and numeric values
		data.forEach(function(d)
		{
	    	d.formated_date = new Date(d.Date);
    		d.close = +d.Close;
  		});
		//Find domain values of date and close fields in the file
		var minDate = d3.min(data, function(d) {return d.formated_date;});
		var maxDate = d3.max(data, function(d) {return d.formated_date;});
		var lowClose = d3.min(data, function(d) { return d.close; });
		var highClose = d3.max(data, function(d) { return d.close; });

		const width=1000
		const height=600
		const margin=50

		xdomain=[minDate,maxDate]
		ydomain=[lowClose-30,highClose+30]
		xrange=[0,width]
		yrange=[height,0]	

		console.log(xdomain)
		console.log(ydomain)
		
		var xscale = d3.scaleTime().domain(xdomain).range(xrange);
		var yscale = d3.scaleLinear().domain(ydomain).range(yrange);

		// Appending SVG element to the chart-container
			const svg = d3
			.select("#chart-container")
			.append("svg")
			.attr("width", width)
			.attr("height", height)
			.append("g")
			.attr("transform", `translate(${margin}, ${margin})`);


		// Filter data based on dropdown selection
			/* d3.select("#dd_date_range")
						.on("change", function () {
							const selectedValue = this.value;
							let filteredData = data;
							if(selectedValue="5years")
							{
								filteredData=(d.Date).substring((d.Date).length-4,(d.Date).length)=="2023"
							}*/

		// Line construction 
			const line = d3.line()
			.x(d => xscale(d.formated_date))
			.y(d => yscale(d.close));

		// Line chart
			svg.append("path")
			.datum(data)
			.attr("fill", "none")
			.attr("stroke", "orange")
			.attr("stroke-width", 2)
			.attr("d", line);

			// Chart title
			svg.append("text")
			.attr("x", width / 2)
			.attr("y", -10)
			.attr("text-anchor", "middle")
			.attr("font-size", 32)
			.attr("font-weight", "bold")
			.attr("fill", "blue")
			.text("JPM Stock Prices");

			// X-axis label
			svg.append("text")
			.attr("x", width / 2)
			.attr("y", height - 50)
			.attr("text-anchor", "middle")
			.text("Date");

			// Y-axis label
			svg.append("text")
			.attr("transform", "rotate(-90)")
			.attr("x", -height/2)
			.attr("y", -40)
			.attr("text-anchor", "middle")
			.text("Closing Price");

			// Adding data points as circles 
			svg.selectAll("circle")
			.data(data)
			.enter()
			.append("circle")
			.attr("cx", d => xscale(d.formated_date))
			.attr("cy", d => yscale(d.close))
			.attr("r", 2)
			.attr("fill-opacity",0.10)
			.on("mouseover", (d) => 
			{
				// Tooltip on mouse-over
				const tooltip = 
				svg.append("g")
				.attr("class", "tooltip")
				.attr("transform", 'translate(50,50)')
				.attr('font-style',"oblique")

				tooltip.append("text")
				.attr("x", 10)
				.attr("y", -10)
				.text('Date:'+d.Date)

				tooltip.append("text")
				.attr("x", 10)
				.attr("y", 10)
				.text('Open:'+d.Open)

				tooltip.append("text")
				.attr("x", 10)
				.attr("y", 30)
				.text('High:'+d.High)

				tooltip.append("text")
				.attr("x", 10)
				.attr("y", 50)
				.text('Low:'+d.Low)

				tooltip.append("text")
				.attr("x", 10)
				.attr("y", 70)
				.text('Close:'+ d.close)

				tooltip.append("text")
				.attr("x", 10)
				.attr("y", 90)
				.text('Volume:'+d.Volume)

				// Add a vertical line to indicate the data point on the x-axis
				tooltip.append("line")
				.attr("transform", `translate(${xscale(d.formated_date)-50},${yscale(d.close)-50})`)
				.attr("x1", 0)
				.attr("y1", -height)
				.attr("x2", 0)
				.attr("y2", height)
				.attr("stroke", "gray")
				.attr("stroke-dasharray", "5,5");
				})
				.on("mouseout", () =>
				{
					// Remove tooltip on mouse-out
					svg.select(".tooltip").remove();
				});

		//Construct X and Y axis
		d3.select("svg").append("g")
		.attr("transform","translate("+margin+","+(margin+530)+")")
		.call(d3.axisBottom(xscale))

		d3.select("svg").append("g")
		.attr("transform","translate("+margin+","+margin+")")
		.call(d3.axisLeft(yscale))
	}

}
</script>
</body>
</html>


